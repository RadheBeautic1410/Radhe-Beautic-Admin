datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  MOD
  REFERRER
  USER
  SELLER
  UPLOADER
  RESELLER
  SHOP_SELLER
  SELLER_MANAGER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  TRACKINGPENDING
  DELIVERED
  CANCELLED
}

enum Status {
  PENDING
  ACCEPTED
  REJECTED
}

enum CartStatus {
  PENDING
  ORDERED
}

enum OfflineSellType {
  HALL_SELL_OFFLINE
  SHOP_SELL_OFFLINE
  HALL_SELL_ONLINE
}

enum OnlineSellType {
  HALL_SELL_ONLINE
  SHOP_SELL_ONLINE
}

enum PaymentStatus {
  COMPLETED
  PENDING
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String?
  phoneNumber   String    @unique
  email         String?
  emailVerified DateTime?
  image         String?
  password      String?
  organization  String?
  isVerified    Boolean   @default(false)

  verifiedBy String?   @db.ObjectId
  verifiedAt DateTime?
  groupName  String?   @default("")
  role       UserRole  @default(USER)

  isTwoFactorEnabled    Boolean                @default(false)
  twoFactorConfirmation TwoFactorConfirmation?

  verifiedByUser User? @relation("VerifiedBy", fields: [verifiedBy], references: [id], onDelete: NoAction, onUpdate: NoAction)

  verifiedUsers      User[]              @relation("VerifiedBy")
  cart               Cart[]
  orders             Orders[]
  Address            Address[]
  balance            Float               @default(0)
  WalletHistory      WalletHistory[]     @relation(name: "UserWalletHistory")
  shop               Shop?               @relation("ShopOwner")
  ShippingChangeLog  ShippingChangeLog[]
  WalletRequest      WalletRequest[]
  resellersCustomers ResellersCustomer[]
  customerOrders     CustomerOrder[]
}

model VerificationToken {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  phoneNumber String
  token       String   @unique
  expires     DateTime

  @@unique([phoneNumber, token])
}

model PasswordResetToken {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  phoneNumber String
  token       String   @unique
  expires     DateTime

  @@unique([phoneNumber, token])
}

model TwoFactorToken {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  phoneNumber String
  token       String   @unique
  expires     DateTime

  @@unique([phoneNumber, token])
}

model TwoFactorConfirmation {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
}

// secret Token

model SecretToken {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  cfUserName    String
  token         String   @unique
  discordId     String
  tokenIssuedAt DateTime @default(now())
  expires       DateTime

  @@unique([cfUserName, token])
}

model Party {
  id                  String @id @default(auto()) @map("_id") @db.ObjectId
  normalizedLowerCase String @unique
  name                String
  countOfPiece        Int    @default(0)
}

model Category {
  id                  String  @id @default(auto()) @map("_id") @db.ObjectId
  normalizedLowerCase String  @unique
  code                String? @unique
  name                String
  type                String?
  kurtiType           String?
  image               String?
  countTotal          Int     @default(0)
  totalItems          Int     @default(0)
  isDeleted           Boolean @default(false)
  bigPrice            Float?
  customerBigPrice    Float?
  walletDiscount      Int?    @default(0)
  sellingPrice        Float?
  actualPrice         Float?
  customerPrice       Float?
  isStockReady        Boolean @default(true)
  isVisibleForCustomer Boolean @default(true)
}

model Prices {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  sellingPrice1 Int           @default(0)
  sellingPrice2 Int           @default(0)
  sellingPrice3 Int           @default(0)
  actualPrice1  Int           @default(0)
  actualPrice2  Int           @default(0)
  actualPrice3  Int           @default(0)
  Kurti         Kurti[]
  Sell          Sell[]
  OfflineSell   OfflineSell[]
  OnlineSell    OnlineSell[]
}

model Kurti {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  pricesId        String?  @db.ObjectId
  sizes           Json[]
  reservedSizes   Json[]   @default([])
  party           String
  sellingPrice    String
  actualPrice     String
  customerPrice   Float?
  category        String
  code            String   @unique
  images          Json[]
  isDeleted       Boolean  @default(false)
  countOfPiece    Int      @default(0)
  lastUpdatedTime DateTime
  videos          Json[]
  isBigPrice      Boolean  @default(false)
  bigPrice        Float?
  weight          Int?     // Weight in grams

  prices            Prices?             @relation(fields: [pricesId], references: [id], onDelete: NoAction)
  CartProduct       CartProduct[]
  Sell              Sell[]
  MovedKurtiHistory MovedKurtiHistory[]
  TopSoldKurti      TopSoldKurti?
  OfflineSell       OfflineSell[]
  OnlineSell        OnlineSell[]
  createdAt         DateTime?           @default(now())
  updatedAt         DateTime?           @updatedAt
}

model ShippingRate {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  pincode     String   // Pincode pattern (wildcard like 36**, or range like 364001-364005, or exact)
  rate        Float    // Shipping rate in currency
  type        String   // Type: "wildcard", "range", or "exact"
  isActive    Boolean  @default(true)
  description String?  // Optional description
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([pincode])
  @@map("shipping_rates")
}

model Sell {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  sellTime      DateTime
  code          String
  kurtiSize     String
  sellerName    String
  kurti         Json[]
  kurtiId       String?    @db.ObjectId
  pricesId      String?    @db.ObjectId
  prices        Prices?    @relation(fields: [pricesId], references: [id], onDelete: NoAction)
  kurti2        Kurti?     @relation(fields: [kurtiId], references: [id], onDelete: NoAction)
  shopLocation  String? // Location of the shop
  customerName  String? // Customer name
  customerPhone String? // Customer phone (optional)
  selledPrice   Int? // Actual selling price (can be different from MRP)
  invoiceNumber String? // Invoice number for tracking
  quantity      Int?
  shopName      String?
  paymentType   String?
  billCreatedBy String?
  batchId       String? // Reference to SaleBatch
  batch         SaleBatch? @relation("BatchSales", fields: [batchId], references: [id])

  @@map("Sell")
}

// If you need to create a separate table for batch sales (optional)
model SaleBatch {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  batchNumber   String   @unique // Unique batch identifier
  customerName  String
  customerPhone String?
  shopLocation  String
  shopName      String
  billCreatedBy String
  totalAmount   Int // Total amount for the entire batch
  totalItems    Int // Total number of items in batch
  saleTime      DateTime
  sellerName    String
  sellerId      String?

  // Relations
  sales Sell[] @relation("BatchSales")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sale_batches")
}

model OfflineSellBatch {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  batchNumber   String          @unique
  customerName  String
  customerPhone String?
  billCreatedBy String
  totalAmount   Int
  totalItems    Int
  saleTime      DateTime
  sellerName    String
  invoiceNumber Int?
  invoiceUrl    String?
  sellType      OfflineSellType @default(SHOP_SELL_OFFLINE)
  sales         OfflineSell[]   @relation("OfflineBatchSales")
  shopId        String?         @db.ObjectId
  shop          Shop?           @relation(fields: [shopId], references: [id])
  createdAt     DateTime?
  updatedAt     DateTime?
  paymentType   String?
  gstType       String?
  Orders        Orders?         @relation(fields: [ordersId], references: [id])
  ordersId      String?         @db.ObjectId
  WalletHistory WalletHistory[]

  @@map("offline_sale_batches")
}

model OfflineSell {
  id            String           @id @default(auto()) @map("_id") @db.ObjectId
  sellTime      DateTime
  code          String
  kurtiSize     String
  kurtiId       String           @db.ObjectId
  kurti         Kurti            @relation(fields: [kurtiId], references: [id])
  batchId       String           @db.ObjectId
  batch         OfflineSellBatch @relation("OfflineBatchSales", fields: [batchId], references: [id])
  createdAt     DateTime?
  updatedAt     DateTime?
  pricesId      String?          @db.ObjectId
  prices        Prices?          @relation(fields: [pricesId], references: [id], onDelete: NoAction)
  shopLocation  String?
  customerName  String?
  customerPhone String?
  quantity      Int?
  selledPrice   Int?
}

model OnlineSellBatch {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  batchNumber   String         @unique
  customerName  String
  customerPhone String?
  billCreatedBy String
  totalAmount   Int
  totalItems    Int
  saleTime      DateTime
  sellerName    String
  invoiceNumber Int?
  invoiceUrl    String?
  sellType      OnlineSellType @default(HALL_SELL_ONLINE)
  sales         OnlineSell[]   @relation("OnlineBatchSales")
  createdAt     DateTime?
  updatedAt     DateTime?

  paymentStatus PaymentStatus @default(PENDING)
  gstType       String?

  orderId       String?
  order         Orders?         @relation(fields: [orderId], references: [orderId])
  WalletHistory WalletHistory[]

  @@map("online_sale_batches")
}

model OnlineSell {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  sellTime      DateTime
  code          String
  kurtiSize     String
  kurtiId       String          @db.ObjectId
  kurti         Kurti           @relation(fields: [kurtiId], references: [id])
  batchId       String          @db.ObjectId
  batch         OnlineSellBatch @relation("OnlineBatchSales", fields: [batchId], references: [id])
  pricesId      String?         @db.ObjectId
  prices        Prices?         @relation(fields: [pricesId], references: [id], onDelete: NoAction)
  shopLocation  String?
  customerName  String?
  customerPhone String?
  quantity      Int?
  selledPrice   Int?
  createdAt     DateTime?
  updatedAt     DateTime?
}

model Deletetime {
  id    String    @id @default(auto()) @map("_id") @db.ObjectId
  owner String    @unique
  time  DateTime?
}

model Cart {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  userId         String          @db.ObjectId
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  CartProduct    CartProduct[]
  orders         Orders[]
  customerOrders CustomerOrder[]
  isOrdered      CartStatus      @default(PENDING)
}

model CartProduct {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  kurtiId        String  @db.ObjectId
  kurti          Kurti   @relation(fields: [kurtiId], references: [id], onDelete: Cascade)
  sizes          Json[]
  isRejected     Boolean @default(false)
  adminSideSizes Json[]
  scannedSizes   Json[]
  Cart           Cart?   @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId         String? @db.ObjectId
}

model Orders {
  id                 String              @id @default(auto()) @map("_id") @db.ObjectId
  orderId            String              @unique
  cart               Cart                @relation(fields: [cartId], references: [id])
  cartId             String              @db.ObjectId
  userId             String              @db.ObjectId
  date               DateTime            @default(now())
  trackingIdImages   Json[]
  status             OrderStatus         @default(PENDING)
  total              Int
  shippingAddress    Address             @relation(fields: [addressId], references: [id])
  shippingCharge     Int                 @default(0)
  addressId          String              @db.ObjectId
  trackingId         String?
  courier            String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  resellerCustomer   ResellersCustomer   @relation(fields: [resellerCustomerId], references: [id], onDelete: Cascade)
  resellerCustomerId String              @db.ObjectId
  user               User?               @relation(fields: [userId], references: [id])
  OfflineSellBatch   OfflineSellBatch[]
  OnlineSellBatch    OnlineSellBatch[]
  ShippingChangeLog  ShippingChangeLog[]
}

model Address {
  id             String          @id @default(auto()) @map("_id") @db.ObjectId
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String          @db.ObjectId
  fullName       String?
  phoneNumber    String?
  address        String
  city           String?
  state          String?
  zipCode        String?
  landmark       String?
  orders         Orders[]
  customerOrders CustomerOrder[]

  // Index for foreign key lookups
  @@index([userId])
}

model OrderCounter {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  date     String @unique
  sequence Int
}

model MovedKurtiHistory {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  kurtiId      String   @db.ObjectId
  kurti        Kurti    @relation(fields: [kurtiId], references: [id], onDelete: Cascade)
  fromCategory String
  toCategory   String
  oldKurtiCode String
  newKurtiCode String
  sizes        Json[]
  date         DateTime @default(now())
}

model TopSoldKurti {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  kurtiId   String   @unique
  kurti     Kurti    @relation(fields: [kurtiId], references: [id])
  soldCount Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Shop {
  id               String             @id @default(auto()) @map("_id") @db.ObjectId
  shopName         String
  shopLocation     String
  shopAddress      String?
  ownerId          String?            @unique @db.ObjectId
  owner            User?              @relation("ShopOwner", fields: [ownerId], references: [id])
  OfflineSellBatch OfflineSellBatch[]
  isHallSell       Boolean            @default(false)
}

model WalletHistory {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  user          User          @relation("UserWalletHistory", fields: [userId], references: [id])
  amount        Float
  type          WalletTxnType
  paymentMethod String
  paymentType   String

  onlineSellBatchId  String?           @db.ObjectId
  offlineSellBatchId String?           @db.ObjectId
  offlineSellBatch   OfflineSellBatch? @relation(fields: [offlineSellBatchId], references: [id], onDelete: Cascade)
  onlineSellBatch    OnlineSellBatch?  @relation(fields: [onlineSellBatchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
}

enum WalletTxnType {
  CREDIT
  DEBIT
}

model ShippingChangeLog {
  id                     String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId                String   @db.ObjectId
  order                  Orders   @relation(fields: [orderId], references: [id])
  previousTrackingId     String?
  newTrackingId          String?
  previousShippingCharge Int?
  newShippingCharge      Int?
  changedBy              String   @db.ObjectId
  changedByUser          User     @relation(fields: [changedBy], references: [id])
  changeReason           String? // Optional reason for the change
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("shipping_change_logs")
}

model WalletRequest {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  resellerId  String    @db.ObjectId
  reseller    User      @relation(fields: [resellerId], references: [id], onDelete: Cascade)
  amount      Float
  status      Status    @default(PENDING)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  approvedBy  String?   @db.ObjectId
  approvedAt  DateTime?
  image       String
  paymentType String
}

model NewReleseSetting {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  imageUrl   String // public Firebase download URL
  imagePath  String
  title      String
  startPrice Int
  endPrice   Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model QRCodeImage {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  image_url String
  is_active Boolean
}

model ResellersCustomer {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  // address    String
  isActive   Boolean   @default(true)
  createdAt  DateTime?
  updatedAt  DateTime?
  resellerId String    @db.ObjectId
  orders     Orders[]
  reseller   User      @relation(fields: [resellerId], references: [id], onDelete: Cascade)
}

model OtherProduct {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  categoryName String
  productType  String
  subType      String?
  description  String?
  images       Json[]
  isDeleted    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Offer {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  qty         Int
  totalAmount Float?
  categories  String[] // Array of category IDs
  image       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CustomerOrder {
  id               String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId          String        @unique
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String        @db.ObjectId
  cart             Cart          @relation(fields: [cartId], references: [id])
  cartId           String        @db.ObjectId
  shippingAddress  Address       @relation(fields: [addressId], references: [id])
  addressId        String        @db.ObjectId
  status           OrderStatus   @default(PENDING)
  total            Float
  shippingCharge   Float         @default(0)
  trackingId       String?
  trackingIdImages Json[]        @default([])
  courier          String?
  paymentStatus    PaymentStatus @default(PENDING)
  paymentType      String?
  note             String?
  paymentScreenshot String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Indexes for query performance
  @@index([userId, status, createdAt])
  @@index([status, createdAt])
  @@index([userId, createdAt])
  @@index([cartId])
  @@index([addressId])
}
